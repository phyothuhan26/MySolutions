@startuml
title G&G Side: Excel Import (Scheduler)
hide footbox

participant "Scheduler" as SCH
participant "File Server" as FS
participant "G&G Import Service" as IMP
database "fail_record" as FDB
database "yps_integration" as YPSDB

SCH -> FS: Access file server to retrieve failed Excel list
FS --> SCH: Excel file (filename, rows)

SCH -> IMP: Start import(filename, excelRows)

activate IMP

' (e) Every access must insert a record into fail_record
IMP -> FDB: INSERT fail_record(\n  accestime=now,\n  processstatus="PROCESS",\n  retry=retryCount,\n  filename,\n  totaltransactions=excelRows.count,\n  remark=null\n)
FDB --> IMP: OK

IMP -> YPSDB: BEGIN TRANSACTION
activate YPSDB

loop For each row in Excel
  IMP -> IMP: actualTransactionTime(shiftTime)

  IMP -> YPSDB: INSERT INTO yps_integration(\n  censq,\n  transaction_frequency,\n  last_transaction_time,\n  payload\n) VALUES (..., actualTransactionTime, ...)
  alt Insert failed for a row
    YPSDB --> IMP: Error (insert failed)

    IMP -> YPSDB: ROLLBACK
    YPSDB --> IMP: Rolled back
    deactivate YPSDB

    IMP -> FDB: UPDATE fail_record\nSET processstatus="FAIL",\nremark="Insert failed -> rollback"\nWHERE id=latestInserted
    FDB --> IMP: OK

    IMP --> SCH: Import failed (rollback done)
    deactivate IMP
    return
  else Insert success
    YPSDB --> IMP: OK
  end
end

IMP -> YPSDB: COMMIT
YPSDB --> IMP: Committed
deactivate YPSDB

IMP -> FDB: UPDATE fail_record\nSET processstatus="SUCCESS",\nremark=null\nWHERE id=latestInserted
FDB --> IMP: OK

IMP --> SCH: Import success
deactivate IMP
@enduml

